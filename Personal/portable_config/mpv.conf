## personal configuration ##
## for mpv v0.37.0-193-g700f72f8 ##
## libplacebo version: v6.338.0-64-g34e019b ##

######################
## renderer and api ##
######################
vo=gpu-next
gpu-api=d3d11
gpu-context=auto
hwdec=no
#hwdec-extra-frames=7
#d3d11va-zero-copy=yes
hwdec-codecs=h264,hevc,av1,vp9

## OpenGL settings ##
opengl-pbo                                                                                         #may be worse
opengl-es=yes

## Vulkan settings ##
vulkan-async-compute=yes
vulkan-swap-mode=fifo                                                                              #fifo (vsync on) or mailbox (triple buffer)
vulkan-queue-count=4                                                                               #1-8. higher values than 1 should help with timing issues

## D3D11 Settings ##
d3d11-feature-level=12_1                                                                           #12_1|12_0|11_1|11_0|10_1|10_0|9_3|9_2|9_1
d3d11-output-format=rgb10_a2
d3d11-output-csp=auto

#####################
## scaling options ##
##################### 
## Upscaling ##
sigmoid-upscaling=yes
scale=lanczos
scale-blur=0.9812505644269356
scale-antiring=0.6

## Chroma Upscaling ##
cscale=lanczos
cscale-radius=3.0
cscale-blur=0.9812505644269356
cscale-antiring=0.6

## Downscaling ##
correct-downscaling=yes
linear-downscaling=yes
dscale=hermite
dscale-antiring=0.6

#######################################
## color management and tone mapping ##
#######################################
target-colorspace-hint                                                                             #enables HDR.
video-output-levels=full

## tone mapping ##
libplacebo-opts-append=knee_adaptation=0.7
hdr-compute-peak=yes
libplacebo-opts-append=tone_map_metadata=cie_y
allow-delayed-peak-detect=no
hdr-peak-percentile=99.9985                                                                        #100 can be a little unstable and result in flickering
hdr-peak-decay-rate=10.0
hdr-contrast-recovery=0.25
hdr-contrast-smoothness=15

## gamut mapping ##
gamut-mapping-mode=perceptual
libplacebo-opts-append=perceptual_strength=1.0
libplacebo-opts-append=gamut_expansion=no

## dithering ##
dither-depth=10
dither=fruit
error-diffusion=burkes                                                                             #applicable only when dither=error-diffusion. jarvis-judice-ninke, stucki, burkes, sierra-3, sierra-2
dither-size-fruit=7                                                                                #max 8, default 6. higher values result in delayed playback
temporal-dither=yes

## ICC ##
icc-intent=1
icc-use-luma=no
icc-cache-dir="~~/icc_cache"

#####################
## motion handling ##
#####################
#display-fps-override=165
video-sync=display-resample                                                                        #display-resample (resamples audio) or display-tempo (applies tempo correction to audio to avoid pitch shift)
video-sync-max-factor=5
video-sync-max-video-change=2.0                                                                    #percent speed change to match refresh rate. default 1.

## interpolation settings ##
interpolation
interpolation-threshold=0.02                                                                       #percent value of video/display mismatch below which interpolation will be disabled
interpolation-preserve=yes
tscale=oversample
#tscale-blur=0.6991556596428412
#tscale-radius=1.005
#tscale-clamp=0.0
#tscale-antiring=0.0

###############
## debanding ##
###############
deband=yes
deband-iterations=2                                                                                #1-16. diminishing returns
deband-threshold=65
deband-range=64                                                                                    #more iterations=less range and vice versa
deband-grain=16

#####################
## even more stuff ##
#####################

## Audio settings ##
volume=100
volume-max=100
volume-gain=-15
volume-gain-max=12
volume-gain-min=-150
audio-exclusive=no
ad-lavc-downmix=no
audio-channels=stereo
audio-normalize-downmix=no                                                                         #not needed with the current audio auto profiles
audio-file-auto=fuzzy
audio-file-paths=audio;audios;**
alang=english,eng,en

## Subtitle settings ##
#no-sub                                                                                            #disabled by default
sub-visibility=no
demuxer-mkv-subtitle-preroll=yes
sub-fix-timing=yes
sub-auto=fuzzy
sub-file-paths=sub;subs;subtitle;subtitles;**
slang=english,eng,en
sub-color='1.0/1.0'
sub-gray=yes
sub-border-color='0.0/0.6'
sub-border-size=1.5
sub-font='Roboto'
sub-font-size=45
sub-italic=no
sub-bold=no

# OSD/OSC settings
osd-bar=no
osd-fractions
osd-color='1.0/1.0'
osd-border-color='0.1/0.6'
osd-border-size=1.5
osd-font='ShinGoPro-Regular'
script-opts-append=stats-font="ShinGoPro-Regular"
osd-font-size=54.5
osd-italic=no
osd-bold=no
script-opts-append=osc-layout=bottombar
script-opts-append=osc-seekbarstyle=bar
script-opts-append=osc-vidscale=no
script-opts-append=osc-scalewindowed=1.5
script-opts-append=osc-scalefullscreen=1.5
script-opts-append=stats-plot_tonemapping_lut=yes
script-opts-append=console-font_size=24
script-opts-append=console-scale_with_window=no

# Window settings
fullscreen
keep-open=yes
force-window=immediate

## Stream Cache Settings ##
cache=yes
cache-secs=7200
demuxer-readahead-secs=7200
demuxer-max-bytes=2400MiB                                                                          #limits readahead secs.
demuxer-max-back-bytes=600Mib                                                                      #rewind cache.
cache-pause=yes
cache-pause-wait=2
prefetch-playlist=yes

## Watch Later ##
save-position-on-quit=yes
ignore-path-in-watch-later-config=yes

## screenshots ##
screenshot-format=jxl
screenshot-template=mpv%f%P%%[#][0X]n
screenshot-directory="C:\users\unsha\MPVStable\screenshots"
screenshot-tag-colorspace=yes
screenshot-high-bit-depth=yes
screenshot-jpeg-quality=99
screenshot-jxl-distance=0.1
screenshot-jxl-effort=7                                                                            #default 3, 0-9. increases cpu time

## yt-dlp ##
#script-opts-append=ytdl_hook-ytdl_path=yt-dlp
script-opts-append=ytdl_hook-all_formats=yes
script-opts-append=ytdl_hook-force_all_formats=yes
script-opts-append=ytdl_hook-try_ytdl_first=yes

#ytdl-raw-options=format-sort="hdr,res,vbr,codec,proto:m3u8",user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0",cookies-from-browser=firefox
ytdl-format=bestvideo*[vbr<55000][dynamic_range!*=SDR]+bestaudio / bestvideo*[vbr<55000]+bestaudio / bestvideo+bestaudio / best

## Storage Cache Settings ##
gpu-shader-cache
gpu-shader-cache-dir="~~/shadercache"

## Miscellaneous settings ##
priority=belownormal
dvd-device=D:
idle
hr-seek=yes
hr-seek-framedrop=yes                                                                              #set to no when using mvtools
media-controls=no

osd-status-msg=${playback-time/full} / ${duration} (${percent-pos}%)\nframe: ${estimated-frame-number} / ${estimated-frame-count}

#vf=@ONNX_luma:vapoursynth="~~/vapoursynth_scripts/ONNX_luma.vpy"

###################
## auto profiles ##
###################
include="~~/anime_profiles.conf"

[extension.gif]
loop-file=inf

[extension.jpg]
pause

[extension.png]
pause

## resolution-dependent auto profiles ##

[HD]
profile-cond=(width >=1920)
profile-desc="HD"
profile=ResClear
#glsl-shaders-append="~~/shaders/Luma_Scalers/Downscalers/luma_downscaler_hermite.glsl"
glsl-shaders-append="~~/shaders/Chroma_Scalers/CfL_Custom.glsl"

[SD]
profile-cond=(width <1920)
profile-desc="SD"
profile=ResClear
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x4_16-0-4-1.glsl"
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x3_16-0-4-1.glsl"
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x2_8-0-4-1.glsl"
glsl-shaders-append="~~/shaders/Chroma_Scalers/CfL_Custom.glsl"

## fps-dependent auto profiles ##

#[HFR]
#profile-cond=(p["estimated-vf-fps"] >=50)
#profile-desc="High Framerate"
#tscale-radius=6
#
#[LFR]
#profile-cond=(p["estimated-vf-fps"] <=40)
#profile-desc="Low Framerate"
#tscale-radius=1.005

## trc-dependent auto profiles ##

[HDR]
profile-cond=get("video-out-params/max-luma") > 203
profile-desc="HDR"
target-peak=1207
target-trc=pq
target-contrast=34486
target-prim=bt.2020
tone-mapping=st2094-10
tone-mapping-param=-0.5
hdr-compute-peak=yes                                                                               #this doesn't need to be specified here but I may want to change it conditionally later
inverse-tone-mapping=no
libplacebo-opts-append=gamut_expansion=no
#saturation=0
profile=TrcClear
glsl-shaders-append="~~/shaders/hdr-toys-master/transfer-function/pq_inv.glsl"
glsl-shaders-append="~~/shaders/hdr-toys-master/utils/black_point_compensation.glsl"
glsl-shaders-append="~~/shaders/hdr-toys-master/transfer-function/pq.glsl"

[SDR]
profile-cond=get("video-params/sig-peak") <= 1
profile-desc="SDR"
target-peak=203
target-trc=pq
target-contrast=5800
target-prim=bt.2020
tone-mapping=gamma
tone-mapping-param=0
inverse-tone-mapping=no
libplacebo-opts-append=gamut_expansion=no
#saturation=0
profile=TrcClear

## color gamut-dependent auto profiles ##

[SCG]
profile-cond=(p["video-params/primaries"]=="bt.601-525" or p["video-params/primaries"]=="bt.601-625" or p["video-params/primaries"]=="bt.709")
deband-iterations=2
deband-range=64

[WCG]
profile-cond=(p["video-params/primaries"]=="bt.2020")
deband-iterations=1
deband-range=32                                                                                         #deband WCG content less

[Stereo]
profile-cond=get("audio-params/channel-count") < 4
af-remove=lavfi="pan=stereo|FL<FC+FLC+FL+BL+SL+LFE|FR<FC+FRC+FR+BR+SR+LFE"
af-remove=lavfi="pan=stereo|FL<FC+FL+BL+LFE|FR<FC+FR+BR+LFE"

[5.1-Surround]
profile-cond=get("audio-params/channel-count") >= 5 and get("audio-params/channel-count") < 7
profile=Stereo
#af=lavfi="lowpass=c=LFE:f=120,volume=1.6,pan=stereo|FL=0.5*FC+0.707*FL+0.707*BL+0.5*LFE|FR=0.5*FC+0.707*FR+0.707*BR+0.5*LFE"
af-add=lavfi="pan=stereo|FL<FC+FL+BL+LFE|FR<FC+FR+BR+LFE"

[7.1-Surround]
profile-cond=get("audio-params/channel-count") >= 7
profile=Stereo
#af=lavfi="lowpass=c=LFE:f=120,volume=1.6,pan=stereo|FL=0.5*FC+0.3*FLC+0.3*FL+0.3*BL+0.3*SL+0.5*LFE|FR=0.5*FC+0.3*FRC+0.3*FR+0.3*BR+0.3*SR+0.5*LFE"
af-add=lavfi="pan=stereo|FL<FC+FLC+FL+BL+SL+LFE|FR<FC+FRC+FR+BR+SR+LFE"

#[af_insert]
#profile-cond=speed ~= 1
#profile-restore=copy
#af-add=rubberband=engine=finer:window=long:phase=independent:transients=smooth:smoothing=on:pitch=quality

[twitch]
profile-cond=get("path", ""):find("^https://www.twitch.tv/") ~= nil
profile-restore=copy-equal
sub-font-size=30
sub-align-x=right
sub-align-y=top

######################
## utility profiles ##
#####################

[ResClear]                                                                                         #this profile exists as an alternative to glsl-shaders-clr for res affected auto profiles only
profile-desc="Clear shaders from active Res profiles"
glsl-shaders-remove="~~/shaders/Chroma_Scalers/CfL_Custom.glsl"
glsl-shaders-remove="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x4_16-0-4-1.glsl"
glsl-shaders-remove="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x3_16-0-4-1.glsl"
glsl-shaders-remove="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/FSRCNNX_x2_8-0-4-1.glsl"
glsl-shaders-remove="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/Tsuba/TsubaUP.glsl"
#glsl-shaders-remove="~~/shaders/Luma_Scalers/Downscalers/luma_downscaler_hermite.glsl"
profile=AnimeClear

[TrcClear]                                                                                         #this profile exists as an alternative to glsl-shaders-clr for trc affected auto profiles only
glsl-shaders-remove="~~/shaders/hdr-toys-master/transfer-function/pq_inv.glsl"
glsl-shaders-remove="~~/shaders/hdr-toys-master/utils/black_point_compensation.glsl"
glsl-shaders-remove="~~/shaders/hdr-toys-master/transfer-function/pq.glsl"

#####################
## manual profiles ##                                                                              #don't forget to map manual profiles to inputs
#####################

[HDR->SDR]
profile-desc="HDR to SDR dynamic tone-mapping"
target-peak=203
target-trc=bt.1886
target-contrast=1000
target-prim=bt.709
tone-mapping=spline
tone-mapping-param=0.3                                                                             #this needs to be tested and revised
hdr-compute-peak=yes
inverse-tone-mapping=no
libplacebo-opts-append=gamut_expansion=no
#saturation=0
profile=TrcClear

[SDR->HDR]                                                                                         #desaturates heavily in current version
profile-desc="SDR to HDR inverse tone-mapping"
target-peak=600
target-trc=pq
target-contrast=17143
target-prim=bt.2020
tone-mapping=bt.2446a
tone-mapping-param=0
inverse-tone-mapping=yes
libplacebo-opts-append=gamut_expansion=yes
#saturation=5
profile=TrcClear

[KeepAspect]
keepaspect
glsl-shaders-remove="~~/shaders/AspectRatio/NLS#.glsl"

[StretchAspect]
no-keepaspect
glsl-shaders-append="~~/shaders/AspectRatio/NLS#.glsl"
#glsl-shader-opts=VerticalStretch=0.5,HorizontalStretch=0.5,CropAmount=0.25,BarsAmount=0.25

[DVD]
profile=ResClear
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/Tsuba/TsubaUP.glsl"                     #reduce deband-grain or disable debanding if grain makes tsuba hallucinate
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/Tsuba/TsubaUP.glsl"
glsl-shaders-append="~~/shaders/Luma_Scalers/ML_scalers/FSRCNNX/Tsuba/TsubaUP.glsl"
glsl-shaders-append="~~/shaders/Chroma_Scalers/CfL_Custom.glsl"

[benchmark]
audio=no
untimed=yes
video-sync=display-desync
vulkan-swap-mode=immediate
opengl-swapinterval=0
d3d11-sync-interval=0
osd-msg1="FPS: ${estimated-display-fps}"